{% extends "base.html" %}
{% block title %}Captions{% endblock %}

{% block content %}
<div class="container py-4" id="captions-root"
     data-platform="{{ platform or 'Instagram' }}"
     data-kind="{{ kind or 'captions' }}"
     data-lang="{{ lang or 'el' }}"
     data-tone="{{ tone or 'neutral' }}"
     data-n="{{ n or 6 }}"
     data-topic="{{ topic or '' }}"
     data-keywords="{{ keywords or '' }}"
     data-emojis="{{ '1' if emojis else '0' }}"
     data-hashtags="{{ '1' if hashtags else '0' }}"
>
  <!-- Presets -->
  <div class="card p-3 mb-3">
    <div class="d-flex flex-wrap justify-content-between align-items-center">
      <h2 class="h5 mb-2 mb-sm-0">Presets</h2>
      <div class="d-flex gap-2">
        <input class="form-control form-control-sm" type="text" id="presetName" placeholder="Preset name">
        <button class="btn btn-sm btn-outline-primary" type="button" onclick="savePreset()">Save</button>
        <select id="presetSelect" class="form-select form-select-sm" style="min-width:180px"></select>
        <button class="btn btn-sm btn-outline-secondary" type="button" onclick="applyPreset()">Load</button>
        <button class="btn btn-sm btn-outline-danger" type="button" onclick="deletePreset()">Delete</button>
        <button class="btn btn-sm btn-outline-dark" type="button" onclick="clearForm()">Clear form</button>
      </div>
    </div>
  </div>

  <!-- Form -->
  <div class="card p-3">
    <h1 class="h4 mb-3">Generate Captions / Hooks / CTAs</h1>
    {% if error %}<p class="mb-3 text-danger">{{ error }}</p>{% endif %}

    <form method="post" class="row g-3" id="cfgForm">
      <div class="col-12">
        <label class="form-label">Θέμα/Προϊόν</label>
        <input class="form-control" type="text" name="topic" id="topic"
               value="{{ topic or '' }}"
               placeholder="π.χ. Saucony Triumph 22 running sneakers">
      </div>

      <div class="col-12">
        <label class="form-label">Keywords (προαιρετικά)</label>
        <input class="form-control" type="text" name="keywords" id="keywords"
               value="{{ keywords or '' }}"
               placeholder="π.χ. running, cushioning, lightweight, Saucony">
      </div>

      <div class="col-6 col-md-4">
        <label class="form-label">Platform</label>
        {% set p = platform or 'Instagram' %}
        <select class="form-select" name="platform" id="platform">
          <option {{ 'selected' if p=='TikTok' else '' }}>TikTok</option>
          <option {{ 'selected' if p=='Instagram' else '' }}>Instagram</option>
          <option {{ 'selected' if p=='Facebook' else '' }}>Facebook</option>
          <option {{ 'selected' if p=='YouTube Shorts' else '' }}>YouTube Shorts</option>
          <option {{ 'selected' if p=='Pinterest' else '' }}>Pinterest</option>
        </select>
      </div>

      <div class="col-6 col-md-4">
        <label class="form-label">Type</label>
        {% set k = kind or 'captions' %}
        <select class="form-select" name="kind" id="kind">
          <option value="captions" {{ 'selected' if k=='captions' else '' }}>Captions</option>
          <option value="hooks"    {{ 'selected' if k=='hooks' else '' }}>Hooks</option>
          <option value="ctas"     {{ 'selected' if k=='ctas' else '' }}>CTAs</option>
          <option value="all"      {{ 'selected' if k=='all' else '' }}>All (3 lists)</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Language</label>
        {% set l = (lang or 'el') %}
        <select class="form-select" name="lang" id="lang">
          <option value="el" {{ 'selected' if l=='el' else '' }}>Ελληνικά</option>
          <option value="en" {{ 'selected' if l=='en' else '' }}>English</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Tone</label>
        {% set t = (tone or 'neutral') %}
        <select class="form-select" name="tone" id="tone">
          <option value="neutral"   {{ 'selected' if t=='neutral' else '' }}>Neutral</option>
          <option value="energetic" {{ 'selected' if t=='energetic' else '' }}>Energetic</option>
          <option value="luxury"    {{ 'selected' if t=='luxury' else '' }}>Luxury</option>
          <option value="playful"   {{ 'selected' if t=='playful' else '' }}>Playful</option>
          <option value="urgent"    {{ 'selected' if t=='urgent' else '' }}>Urgent</option>
        </select>
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label">Πλήθος</label>
        <input class="form-control" type="number" name="n" id="n" min="3" max="15" step="1" value="{{ n or 6 }}">
      </div>

      <div class="col-6 col-md-3 form-check ms-2">
        <input class="form-check-input" type="checkbox" id="emojis" name="emojis" {% if emojis %}checked{% endif %}>
        <label class="form-check-label" for="emojis">Include emojis</label>
      </div>
      <div class="col-6 col-md-3 form-check">
        <input class="form-check-input" type="checkbox" id="hashtags" name="hashtags" {% if hashtags %}checked{% endif %}>
        <label class="form-check-label" for="hashtags">Include hashtags</label>
      </div>

      <div class="col-12">
        <button class="btn btn-primary" type="submit">Generate</button>
      </div>
    </form>
  </div>

  {% if results %}
    {% set groups = results %}
    {% for key, title in {'hooks':'Hooks','captions':'Captions','ctas':'CTAs'}.items() %}
      {% if groups.get(key) %}
      <div class="card p-3 mt-3">
        <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
          <h3 class="h6 mb-0">{{ title }}</h3>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyAll('{{ key }}')">Copy all</button>
            <div class="btn-group">
              <button class="btn btn-sm btn-outline-success" type="button" onclick="downloadList('{{ key }}','csv')">Download CSV</button>
              <button class="btn btn-sm btn-outline-success" type="button" onclick="downloadList('{{ key }}','txt')">Download TXT</button>
            </div>
          </div>
        </div>
        <ul class="list-group mt-2" id="list-{{ key }}">
          {% for line in groups[key] %}
          <li class="list-group-item d-flex justify-content-between align-items-center">
            <span class="me-3 text-wrap">{{ line }}</span>
            <button class="btn btn-sm btn-outline-secondary" type="button"
                    data-text="{{ line|e }}" onclick="copyOne(this)">Copy</button>
          </li>
          {% endfor %}
        </ul>
      </div>
      {% endif %}
    {% endfor %}

    <!-- Export ALL -->
    <div class="card p-3 mt-3">
      <div class="d-flex flex-wrap gap-2 justify-content-between align-items-center">
        <h3 class="h6 mb-0">Export all results</h3>
        <div class="btn-group">
          <button class="btn btn-sm btn-outline-success" type="button" onclick="downloadAll('csv')">Download ALL (CSV)</button>
          <button class="btn btn-sm btn-outline-success" type="button" onclick="downloadAll('txt')">Download ALL (TXT)</button>
        </div>
      </div>
    </div>
  {% endif %}
</div>

<script>
/* ====== COPY ====== */
function copyOne(btn){
  const t = btn.getAttribute('data-text') || '';
  navigator.clipboard.writeText(t).then(()=>okToast('Copied!'));
}
function copyAll(key){
  const lines = getLinesFromList(key);
  if(!lines.length) return;
  navigator.clipboard.writeText(lines.join('\n')).then(()=>okToast('Copied all!'));
}

/* ====== EXPORT ====== */
function getMeta(){
  const root = document.getElementById('captions-root');
  return {
    platform: root.dataset.platform || 'Instagram',
    kind:     root.dataset.kind || 'captions',
    lang:     root.dataset.lang || 'el',
    tone:     root.dataset.tone || 'neutral',
    n:        root.dataset.n || '0',
    topic:    root.dataset.topic || '',
    keywords: root.dataset.keywords || '',
    emojis:   root.dataset.emojis === '1',
    hashtags: root.dataset.hashtags === '1',
  };
}
function getLinesFromList(key){
  const ul = document.getElementById('list-'+key);
  if(!ul) return [];
  return Array.from(ul.querySelectorAll('li span')).map(s=>s.textContent.trim()).filter(Boolean);
}
function csvEscape(s){
  return '"' + (s || '').replaceAll('"','""') + '"';
}
function buildCSV(rows){
  return rows.map(r => r.map(csvEscape).join(',')).join('\n');
}
function downloadBlob(content, mime, filename){
  const a = document.createElement('a');
  const blob = new Blob([content], {type: mime});
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  document.body.appendChild(a);
  a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
function safeName(s){
  return (s || '').toLowerCase().replace(/[^a-z0-9\u0370-\u03FF\u1F00-\u1FFF\-]+/gi,'-').replace(/-+/g,'-').slice(0,80) || 'captions';
}
function nowStamp(){
  const d = new Date();
  return d.toISOString().replace(/[:.]/g,'-');
}
function downloadList(key, fmt){
  const meta = getMeta();
  const lines = getLinesFromList(key);
  if(!lines.length){ okToast('Empty list'); return; }

  if(fmt==='csv'){
    const header = ["type","text","platform","tone","lang","topic","keywords","emojis","hashtags","generated_at"];
    const rows = [header];
    lines.forEach(t => rows.push([key, t, meta.platform, meta.tone, meta.lang, meta.topic, meta.keywords, meta.emojis, meta.hashtags, nowStamp()]));
    const csv = buildCSV(rows);
    downloadBlob(csv, "text/csv;charset=utf-8", `${safeName(meta.topic)}-${key}-${nowStamp()}.csv`);
  } else {
    downloadBlob(lines.join('\n'), "text/plain;charset=utf-8", `${safeName(meta.topic)}-${key}-${nowStamp()}.txt`);
  }
}
function downloadAll(fmt){
  const groups = ["hooks","captions","ctas"];
  const meta = getMeta();
  const collected = [];
  groups.forEach(k=>{
    getLinesFromList(k).forEach(t => collected.push({type:k, text:t}));
  });
  if(!collected.length){ okToast('Nothing to export'); return; }

  if(fmt==='csv'){
    const header = ["type","text","platform","tone","lang","topic","keywords","emojis","hashtags","generated_at"];
    const rows = [header];
    collected.forEach(row => rows.push([row.type, row.text, meta.platform, meta.tone, meta.lang, meta.topic, meta.keywords, meta.emojis, meta.hashtags, nowStamp()]));
    downloadBlob(buildCSV(rows), "text/csv;charset=utf-8", `${safeName(meta.topic)}-ALL-${nowStamp()}.csv`);
  } else {
    const txt = collected.map(r=>`[${r.type}] ${r.text}`).join('\n');
    downloadBlob(txt, "text/plain;charset=utf-8", `${safeName(meta.topic)}-ALL-${nowStamp()}.txt`);
  }
}

/* ====== PRESETS (localStorage) ====== */
const PRESETS_KEY = 'acs_captions_presets';
function loadPresets(){
  let map = {};
  try { map = JSON.parse(localStorage.getItem(PRESETS_KEY) || '{}'); } catch(e){ map = {}; }
  const sel = document.getElementById('presetSelect');
  sel.innerHTML = '';
  const names = Object.keys(map).sort((a,b)=>a.localeCompare(b));
  names.forEach(n=>{
    const opt = document.createElement('option'); opt.value=n; opt.textContent=n; sel.appendChild(opt);
  });
}
function getFormValues(){
  return {
    topic:     document.getElementById('topic').value || '',
    keywords:  document.getElementById('keywords').value || '',
    platform:  document.getElementById('platform').value,
    kind:      document.getElementById('kind').value,
    lang:      document.getElementById('lang').value,
    tone:      document.getElementById('tone').value,
    n:         document.getElementById('n').value,
    emojis:    document.getElementById('emojis').checked,
    hashtags:  document.getElementById('hashtags').checked
  };
}
function setFormValues(v){
  document.getElementById('topic').value = v.topic || '';
  document.getElementById('keywords').value = v.keywords || '';
  document.getElementById('platform').value = v.platform || 'Instagram';
  document.getElementById('kind').value = v.kind || 'captions';
  document.getElementById('lang').value = v.lang || 'el';
  document.getElementById('tone').value = v.tone || 'neutral';
  document.getElementById('n').value = v.n || 6;
  document.getElementById('emojis').checked = !!v.emojis;
  document.getElementById('hashtags').checked = !!v.hashtags;
}
function savePreset(){
  const name = document.getElementById('presetName').value.trim();
  if(!name){ okToast('Δώσε όνομα preset'); return; }
  let map = {};
  try { map = JSON.parse(localStorage.getItem(PRESETS_KEY) || '{}'); } catch(e){ map = {}; }
  map[name] = getFormValues();
  localStorage.setItem(PRESETS_KEY, JSON.stringify(map));
  loadPresets();
  okToast('Preset saved');
}
function applyPreset(){
  const sel = document.getElementById('presetSelect');
  const name = sel.value;
  if(!name){ okToast('Διάλεξε preset'); return; }
  let map = {};
  try { map = JSON.parse(localStorage.getItem(PRESETS_KEY) || '{}'); } catch(e){ map = {}; }
  if(!map[name]){ okToast('Missing preset'); return; }
  setFormValues(map[name]);
  okToast('Preset loaded');
}
function deletePreset(){
  const sel = document.getElementById('presetSelect');
  const name = sel.value;
  if(!name){ okToast('Διάλεξε preset'); return; }
  let map = {};
  try { map = JSON.parse(localStorage.getItem(PRESETS_KEY) || '{}'); } catch(e){ map = {}; }
  delete map[name];
  localStorage.setItem(PRESETS_KEY, JSON.stringify(map));
  loadPresets();
  okToast('Preset deleted');
}
function clearForm(){
  setFormValues({topic:'',keywords:'',platform:'Instagram',kind:'captions',lang:'el',tone:'neutral',n:6,emojis:false,hashtags:false});
}

/* ====== tiny toast ====== */
function okToast(msg){
  const div = document.createElement('div');
  div.textContent = msg;
  div.style.position='fixed'; div.style.right='16px'; div.style.bottom='16px';
  div.style.padding='8px 12px'; div.style.borderRadius='8px';
  div.style.background='rgba(80,160,80,.9)'; div.style.color='#fff'; div.style.zIndex=9999;
  document.body.appendChild(div);
  setTimeout(()=>{div.remove()}, 1200);
}

/* init */
document.addEventListener('DOMContentLoaded', loadPresets);
</script>
{% endblock %}
