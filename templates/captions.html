{% extends "base.html" %}
{% block title %}Captions{% endblock %}
{% block content %}
<div class="container py-4">

  <h3 class="mb-3">Captions / Hooks / CTAs</h3>

  {% if error %}
    <div class="alert alert-danger">{{ error }}</div>
  {% endif %}

  <form method="post" class="card card-body mb-4">
    <div class="row g-3">
      <div class="col-12 col-md-6">
        <label class="form-label">Topic / Product</label>
        <input type="text" class="form-control" name="topic" value="{{ topic }}" placeholder="π.χ. νέα sneaker drop, running shoes, summer sale">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Tone</label>
        <input type="text" class="form-control" name="tone" value="{{ tone }}" placeholder="e.g. energetic, premium, friendly">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">#Lines</label>
        <input type="number" class="form-control" name="n" value="{{ n or 6 }}" min="3" max="30">
      </div>

      <div class="col-6 col-md-3">
        <label class="form-label">Platform</label>
        <select class="form-select" name="platform">
          {% for p in ["TikTok","Instagram","Facebook","YouTube Shorts","Pinterest"] %}
          <option value="{{p}}" {% if platform==p %}selected{% endif %}>{{p}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Kind</label>
        <select class="form-select" name="kind">
          {% for k in ["captions","hooks","ctas","all"] %}
          <option value="{{k}}" {% if kind==k %}selected{% endif %}>{{k|capitalize}}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Lang</label>
        <select class="form-select" name="lang">
          <option value="el" {% if lang=="el" %}selected{% endif %}>Greek</option>
          <option value="en" {% if lang=="en" %}selected{% endif %}>English</option>
        </select>
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">Keywords (optional)</label>
        <input type="text" class="form-control" name="keywords" value="{{ keywords }}" placeholder="π.χ. lightweight, air, discount...">
      </div>

      <div class="col-6 col-md-2 d-flex align-items-center">
        <div class="form-check me-3">
          <input class="form-check-input" type="checkbox" id="emojis" name="emojis" {% if emojis %}checked{% endif %}>
          <label class="form-check-label" for="emojis">Emojis</label>
        </div>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" id="hashtags" name="hashtags" {% if hashtags %}checked{% endif %}>
          <label class="form-check-label" for="hashtags">#Hashtags</label>
        </div>
      </div>

      <div class="col-12 col-md-3 ms-auto d-grid">
        <button class="btn btn-dark">Generate</button>
      </div>
    </div>
  </form>

  {% if results and (results.captions or results.hooks or results.ctas) %}
  <!-- SAVE ALL controls -->
  <div class="card card-body mb-3">
    <div class="row g-2 align-items-end">
      <div class="col-12 col-md-6">
        <label class="form-label">Default tags for Save All (comma,separated)</label>
        <input type="text" class="form-control" id="saveall-tags" placeholder="π.χ. sneakers,summer,drop">
      </div>
      <div class="col-6 col-md-3">
        <label class="form-label">Platform</label>
        <input type="text" class="form-control" id="saveall-platform" value="{{ platform }}">
      </div>
      <div class="col-6 col-md-2">
        <label class="form-label">Lang</label>
        <input type="text" class="form-control" id="saveall-lang" value="{{ lang }}">
      </div>
      <div class="col-12 col-md-1 d-grid">
        <button class="btn btn-success" onclick="saveAll()">Save All</button>
      </div>
    </div>
  </div>
  {% endif %}

  {% macro block_list(title, items, kindname) %}
    {% if items and items|length %}
    <div class="mb-4">
      <h5 class="mb-2">{{ title }} <span class="badge bg-secondary">{{ items|length }}</span></h5>
      <div class="list-group">
        {% for line in items %}
        <div class="list-group-item">
          <div class="d-flex">
            <div class="flex-grow-1">
              <pre class="mb-0" style="white-space:pre-wrap">{{ line }}</pre>
            </div>
            <div class="ms-2 d-flex flex-column gap-2">
              <button class="btn btn-sm btn-outline-primary" onclick="copyText(`{{ line|replace('`','\\`')|e }}`)">Copy</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}
  {% endmacro %}

  {{ block_list("Hooks", results.hooks, "hooks") }}
  {{ block_list("Captions", results.captions, "captions") }}
  {{ block_list("CTAs", results.ctas, "ctas") }}

</div>

<script>
function copyText(t){
  navigator.clipboard.writeText(t);
}

async function saveAll(){
  const platform = document.getElementById('saveall-platform').value.trim();
  const lang     = document.getElementById('saveall-lang').value.trim();
  const tags     = document.getElementById('saveall-tags').value.trim();

  const all = [];
  const sections = [
    ["hooks", {{ (results.hooks|tojson) if results.hooks else "[]" }}],
    ["captions", {{ (results.captions|tojson) if results.captions else "[]" }}],
    ["ctas", {{ (results.ctas|tojson) if results.ctas else "[]" }}],
  ];
  for (const [kind, arr] of sections){
    for (const line of arr){
      const text = (line || "").toString().trim();
      if (text) all.push({text, platform, lang, kind, tags});
    }
  }
  if (all.length === 0){
    alert("Δεν υπάρχουν γραμμές για αποθήκευση.");
    return;
  }

  const res = await fetch("{{ url_for('snip.bulk_add') }}", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({items: all})
  });
  const j = await res.json();
  if (j.ok){
    alert("Saved " + (j.count || all.length) + " snippets!");
  } else {
    alert(j.error || "Error");
  }
}
</script>
{% endblock %}
